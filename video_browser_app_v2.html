<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Browser & Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/video.js/8.5.2/video.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/video.js/8.5.2/video-js.css" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #4285f4;
        }

        .auth-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #4285f4;
            color: white;
        }

        .btn-primary:hover {
            background: #3367d6;
        }

        .btn-secondary {
            background: #333;
            color: white;
            border: 1px solid #555;
        }

        .btn-secondary:hover {
            background: #444;
        }

        .input-section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .input-field {
            flex: 1;
            min-width: 300px;
            padding: 12px;
            border: 1px solid #555;
            border-radius: 6px;
            background: #333;
            color: #fff;
            font-size: 14px;
        }

        .input-field:focus {
            outline: none;
            border-color: #4285f4;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .file-browser {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            height: fit-content;
        }

        .video-player-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
        }

        .section-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #4285f4;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 14px;
            color: #ccc;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            cursor: pointer;
            color: #4285f4;
            margin-right: 8px;
        }

        .breadcrumb-item:hover {
            text-decoration: underline;
        }

        .file-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .file-item:hover {
            background: #333;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .file-icon {
            width: 20px;
            height: 20px;
            fill: #4285f4;
        }

        .file-name {
            font-size: 14px;
            word-break: break-word;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .play-btn {
            background: #34a853;
            color: white;
        }

        .play-btn:hover {
            background: #2d8f47;
        }

        .download-btn {
            background: #ea4335;
            color: white;
        }

        .download-btn:hover {
            background: #d33b2c;
        }

        .select-btn {
            background: #fbbc04;
            color: black;
        }

        .select-btn:hover {
            background: #f9ab00;
        }

        .bulk-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #ccc;
        }

        .error {
            background: #ea4335;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .success {
            background: #34a853;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .video-js {
            width: 100%;
            height: auto;
        }

        .current-video-info {
            margin-top: 15px;
            padding: 15px;
            background: #333;
            border-radius: 6px;
        }

        .selected-count {
            background: #4285f4;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .input-field {
                min-width: unset;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .file-actions {
                flex-direction: column;
            }
        }

        .folder-icon {
            fill: #fbbc04;
        }

        .video-icon {
            fill: #ea4335;
        }

        .file-item.selected {
            background: #4285f4;
        }

        .checkbox {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">ðŸ“º Video Browser</div>
            <div class="auth-section">
                <div id="userInfo" style="display: none;">
                    <span id="userName"></span>
                    <button class="btn btn-secondary" onclick="signOut()">Sign Out</button>
                </div>
                <button id="authBtn" class="btn btn-primary" onclick="handleAuth()">Sign in with Google</button>
            </div>
        </header>

        <div class="input-section">
            <div class="input-group">
                <input type="text" id="sourceUrl" class="input-field" placeholder="Enter Google Drive Index URL (e.g., https://example.workers.dev/0:/)">
                <button class="btn btn-primary" onclick="loadFromUrl()">Load Index</button>
            </div>
            <div class="input-group">
                <input type="text" id="driveFolder" class="input-field" placeholder="Enter Google Drive Folder ID (optional - leave empty to browse your drive)">
                <button class="btn btn-primary" onclick="loadGoogleDrive()">Load Google Drive</button>
            </div>
            <div style="font-size: 12px; color: #ccc; margin-top: 10px;">
                <strong>Note:</strong> For Google Drive features, you need to configure API_KEY and CLIENT_ID in the code. 
                CORS errors are common with Drive Index URLs - the app will suggest using a proxy if needed.
            </div>
        </div>

        <div id="messageArea"></div>

        <div class="main-content">
            <div class="file-browser">
                <div class="section-title">
                    File Browser
                    <span id="selectedCount" class="selected-count" style="display: none;">0 selected</span>
                </div>
                <div id="breadcrumb" class="breadcrumb"></div>
                <div id="fileList" class="file-list">
                    <div class="loading">Enter a URL or browse Google Drive to get started</div>
                </div>
                <div class="bulk-actions">
                    <button class="btn btn-secondary" onclick="selectAll()">Select All Videos</button>
                    <button class="btn btn-secondary" onclick="clearSelection()">Clear Selection</button>
                    <button class="btn btn-primary" onclick="downloadSelected()">Download Selected</button>
                </div>
            </div>

            <div class="video-player-section">
                <div class="section-title">Video Player</div>
                <div id="videoContainer">
                    <div class="loading">Select a video to play</div>
                </div>
                <div id="currentVideoInfo" class="current-video-info" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentFiles = [];
        let selectedFiles = new Set();
        let currentPath = [];
        let currentSource = null;
        let player = null;
        let isSignedIn = false;

        // Google API configuration
        const API_KEY = null; // Disabled - set to your actual API key to enable
        const CLIENT_ID = null; // Disabled - set to your actual client ID to enable
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
        let gapiInitialized = false;

        // Initialize Google API only when needed
        async function initializeGapi() {
            if (!API_KEY || !CLIENT_ID) {
                console.log('Google API credentials not configured - skipping initialization');
                gapiInitialized = false;
                return;
            }
            
            if (gapiInitialized) return;
            
            try {
                await new Promise((resolve) => gapi.load('auth2', resolve));
                await new Promise((resolve) => gapi.load('client', resolve));
                await initClient();
                await initAuth();
                gapiInitialized = true;
            } catch (error) {
                console.error('Error initializing Google API:', error);
                showMessage('Google API initialization failed. Google Drive features will be disabled.', 'error');
            }
        }

        async function initClient() {
            if (!API_KEY) return;
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
            } catch (error) {
                console.error('Error initializing client:', error);
                throw error;
            }
        }

        async function initAuth() {
            if (!CLIENT_ID) return;
            try {
                const authInstance = gapi.auth2.init({
                    client_id: CLIENT_ID,
                    scope: SCOPES
                });
                
                isSignedIn = authInstance.isSignedIn.get();
                updateAuthUI();
                
                authInstance.isSignedIn.listen(updateAuthUI);
            } catch (error) {
                console.error('Error initializing auth:', error);
                throw error;
            }
        }

        function updateAuthUI() {
            const authBtn = document.getElementById('authBtn');
            const userInfo = document.getElementById('userInfo');
            const userName = document.getElementById('userName');
            
            if (isSignedIn) {
                const user = gapi.auth2.getAuthInstance().currentUser.get();
                const profile = user.getBasicProfile();
                
                authBtn.style.display = 'none';
                userInfo.style.display = 'flex';
                userName.textContent = profile.getName();
            } else {
                authBtn.style.display = 'inline-block';
                userInfo.style.display = 'none';
            }
        }

        async function handleAuth() {
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signIn();
                isSignedIn = true;
                updateAuthUI();
            } catch (error) {
                showMessage('Authentication failed: ' + error.message, 'error');
            }
        }

        async function signOut() {
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signOut();
                isSignedIn = false;
                updateAuthUI();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Utility functions
        function showMessage(message, type = 'success') {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function isVideoFile(filename) {
            const videoExtensions = ['.mp4', '.mkv', '.avi', '.mov', '.wmv', '.flv', '.webm', '.m4v', '.3gp'];
            return videoExtensions.some(ext => filename.toLowerCase().endsWith(ext));
        }

        function getFileIcon(file) {
            if (file.type === 'folder') {
                return '<svg class="file-icon folder-icon" viewBox="0 0 24 24"><path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/></svg>';
            } else if (isVideoFile(file.name)) {
                return '<svg class="file-icon video-icon" viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>';
            }
            return '<svg class="file-icon" viewBox="0 0 24 24"><path d="M6,2A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6Z"/></svg>';
        }

        // Google Drive Index functions with CORS handling
        async function loadFromUrl() {
            const url = document.getElementById('sourceUrl').value.trim();
            if (!url) {
                showMessage('Please enter a valid URL', 'error');
                return;
            }

            try {
                showLoading();
                currentSource = 'index';
                currentPath = [{ name: 'Root', url: url }];
                await fetchIndexFiles(url);
            } catch (error) {
                showMessage('Error loading from URL: ' + error.message + '. Try using a CORS proxy or different URL.', 'error');
                
                // Suggest CORS proxy
                const corsProxy = `https://cors-anywhere.herokuapp.com/${url}`;
                const useProxy = confirm('CORS error detected. Would you like to try using a CORS proxy? (Note: You may need to enable it first by visiting https://cors-anywhere.herokuapp.com/corsdemo)');
                
                if (useProxy) {
                    try {
                        await fetchIndexFiles(corsProxy, true);
                    } catch (proxyError) {
                        showMessage('CORS proxy also failed. The server may not allow cross-origin requests.', 'error');
                    }
                }
            }
        }

        async function fetchIndexFiles(url, isProxy = false) {
            try {
                // Clean up URL
                const cleanUrl = url.endsWith('/') ? url : url + '/';
                
                // Try different methods to fetch the content
                let response;
                let text;
                
                try {
                    response = await fetch(cleanUrl, {
                        method: 'GET',
                        mode: 'no-cors',
                        headers: {
                            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    text = await response.text();
                    
                } catch (fetchError) {
                    // If direct fetch fails, try alternative methods
                    // if (!isProxy) {
                    //     throw new Error(`Failed to fetch: ${fetchError.message}. This might be due to CORS restrictions.`);
                    // } else {
                    //     throw fetchError;
                    // }
                    
                    // Try with CORS proxy as fallback
                    const corsProxies = [
                        'https://api.allorigins.win/raw?url=',
                        'https://cors-anywhere.herokuapp.com/'
                    ];
                    
                    let proxyWorked = false;
                    for (const proxy of corsProxies) {
                        try {
                            response = await fetch(proxy + encodeURIComponent(cleanUrl));
                            if (response.ok) {
                                text = await response.text();
                                proxyWorked = true;
                                break;
                            }
                        } catch (e) {
                            continue;
                        }
                    }
                    
                    if (!proxyWorked) {
                        throw new Error(`CORS error: ${fetchError.message}. The server doesn't allow cross-origin requests.`);
                    }
                }
                
                // Parse the HTML response to extract files
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                
                const files = [];
                
                // Enhanced parsing for different index types
                const parseStrategies = [
                    // Strategy 1: Look for JSON data in script tags (common in modern indexes)
                    () => {
                        const scripts = doc.querySelectorAll('script');
                        for (const script of scripts) {
                            const content = script.textContent;
                            if (content.includes('files') || content.includes('children')) {
                                try {
                                    // Try to extract JSON data
                                    const jsonMatch = content.match(/(?:files|children|data)\s*[:=]\s*(\[.*?\]);?/s);
                                    if (jsonMatch) {
                                        const jsonData = JSON.parse(jsonMatch[1]);
                                        return jsonData.map(item => ({
                                            name: item.name,
                                            type: item.mimeType === 'application/vnd.google-apps.folder' || item.type === 'folder' ? 'folder' : 'file',
                                            url: new URL(item.name, cleanUrl).href,
                                            size: parseInt(item.size) || 0,
                                            downloadUrl: item.type !== 'folder' ? new URL(item.name, cleanUrl).href : null
                                        }));
                                    }
                                } catch (e) {
                                    continue;
                                }
                            }
                        }
                        return null;
                    },
                    
                    // Strategy 2: Parse table rows (common in directory listings)
                    () => {
                        const rows = doc.querySelectorAll('tr');
                        const results = [];
                        for (const row of rows) {
                            const link = row.querySelector('a[href]');
                            if (link) {
                                const href = link.getAttribute('href');
                                const name = link.textContent.trim();
                                if (href && name && !name.startsWith('..') && name !== '/' && name !== 'Parent Directory') {
                                    const isFolder = href.endsWith('/') || name.endsWith('/');
                                    const fullUrl = new URL(href, cleanUrl).href;
                                    results.push({
                                        name: name.replace(/\/$/, ''),
                                        type: isFolder ? 'folder' : 'file',
                                        url: fullUrl,
                                        size: 0,
                                        downloadUrl: isFolder ? null : fullUrl
                                    });
                                }
                            }
                        }
                        return results.length > 0 ? results : null;
                    },
                    
                    // Strategy 3: Parse all links (fallback)
                    () => {
                        const links = doc.querySelectorAll('a[href]');
                        const results = [];
                        for (const link of links) {
                            const href = link.getAttribute('href');
                            const name = link.textContent.trim();
                            if (href && name && !name.startsWith('..') && name !== '/' && !href.startsWith('http') && !href.startsWith('mailto:')) {
                                const isFolder = href.endsWith('/') || link.classList.contains('folder');
                                const fullUrl = new URL(href, cleanUrl).href;
                                results.push({
                                    name: name,
                                    type: isFolder ? 'folder' : 'file',
                                    url: fullUrl,
                                    size: 0,
                                    downloadUrl: isFolder ? null : fullUrl
                                });
                            }
                        }
                        return results.length > 0 ? results : null;
                    }
                ];
                
                // Try each parsing strategy
                for (const strategy of parseStrategies) {
                    const result = strategy();
                    if (result && result.length > 0) {
                        files.push(...result);
                        break;
                    }
                }
                
                if (files.length === 0) {
                    // Last resort: show raw HTML for debugging
                    console.log('Raw HTML content:', text.substring(0, 1000));
                    throw new Error('No files found. The index format might not be supported.');
                }
                
                currentFiles = files;
                renderFiles();
                showMessage(`Loaded ${files.length} items successfully`, 'success');
                
            } catch (error) {
                console.error('Fetch error details:', error);
                throw new Error('Failed to fetch index files: ' + error.message);
            }
        }

        // Google Drive functions
        async function loadGoogleDrive() {
            if (!gapiInitialized) {
                if (!API_KEY || !CLIENT_ID) {
                    showMessage('Google API credentials not configured. Please add your API_KEY and CLIENT_ID to use Google Drive features.', 'error');
                    return;
                }
                await initializeGapi();
            }
            
            if (!isSignedIn) {
                showMessage('Please sign in with Google first', 'error');
                return;
            }

            try {
                showLoading();
                currentSource = 'drive';
                const folderId = document.getElementById('driveFolder').value.trim() || 'root';
                currentPath = [{ name: 'My Drive', id: folderId }];
                await fetchDriveFiles(folderId);
            } catch (error) {
                showMessage('Error loading Google Drive: ' + error.message, 'error');
            }
        }

        async function fetchDriveFiles(folderId = 'root') {
            if (!gapiInitialized) {
                throw new Error('Google API not initialized');
            }
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and trashed = false`,
                    fields: 'files(id,name,mimeType,size,webContentLink,webViewLink)',
                    pageSize: 1000
                });

                const files = response.result.files.map(file => ({
                    name: file.name,
                    type: file.mimeType === 'application/vnd.google-apps.folder' ? 'folder' : 'file',
                    id: file.id,
                    size: parseInt(file.size) || 0,
                    downloadUrl: file.webContentLink,
                    viewUrl: file.webViewLink,
                    mimeType: file.mimeType
                }));

                currentFiles = files;
                renderFiles();
                showMessage(`Loaded ${files.length} items from Google Drive`, 'success');
                
            } catch (error) {
                throw new Error('Failed to fetch Drive files: ' + error.message);
            }
        }

        // File rendering
        function renderFiles() {
            const fileList = document.getElementById('fileList');
            const breadcrumb = document.getElementById('breadcrumb');
            
            // Render breadcrumb
            breadcrumb.innerHTML = currentPath.map((item, index) => 
                `<span class="breadcrumb-item" onclick="navigateToPath(${index})">${item.name}</span>${index < currentPath.length - 1 ? ' / ' : ''}`
            ).join('');
            
            // Render files
            if (currentFiles.length === 0) {
                fileList.innerHTML = '<div class="loading">No files found</div>';
                return;
            }
            
            fileList.innerHTML = currentFiles.map(file => {
                const isSelected = selectedFiles.has(file.id || file.url);
                const isVideo = isVideoFile(file.name);
                
                return `
                    <div class="file-item ${isSelected ? 'selected' : ''}" data-file='${JSON.stringify(file)}'>
                        <div class="file-info">
                            ${isVideo ? `<input type="checkbox" class="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelection(this)">` : ''}
                            ${getFileIcon(file)}
                            <span class="file-name">${file.name}</span>
                        </div>
                        <div class="file-actions">
                            ${file.type === 'folder' ? 
                                `<button class="action-btn select-btn" onclick="navigateToFolder(this)">Open</button>` :
                                isVideo ? 
                                    `<button class="action-btn play-btn" onclick="playVideo(this)">Play</button>
                                     <button class="action-btn download-btn" onclick="downloadFile(this)">Download</button>` :
                                    `<button class="action-btn download-btn" onclick="downloadFile(this)">Download</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
            
            updateSelectedCount();
        }

        function showLoading() {
            document.getElementById('fileList').innerHTML = '<div class="loading">Loading...</div>';
        }

        // Navigation functions
        async function navigateToFolder(button) {
            const fileData = JSON.parse(button.closest('.file-item').dataset.file);
            
            if (currentSource === 'index') {
                currentPath.push({ name: fileData.name, url: fileData.url });
                await fetchIndexFiles(fileData.url);
            } else if (currentSource === 'drive') {
                currentPath.push({ name: fileData.name, id: fileData.id });
                await fetchDriveFiles(fileData.id);
            }
        }

        async function navigateToPath(index) {
            currentPath = currentPath.slice(0, index + 1);
            const target = currentPath[currentPath.length - 1];
            
            if (currentSource === 'index') {
                await fetchIndexFiles(target.url);
            } else if (currentSource === 'drive') {
                await fetchDriveFiles(target.id);
            }
        }

        // Video player functions
        async function playVideo(button) {
            const fileData = JSON.parse(button.closest('.file-item').dataset.file);
            
            try {
                let videoUrl = '';
                
                if (currentSource === 'index') {
                    videoUrl = fileData.downloadUrl;
                } else if (currentSource === 'drive') {
                    // For Google Drive, we need to get a direct link
                    videoUrl = `https://drive.google.com/uc?export=download&id=${fileData.id}`;
                }
                
                await setupVideoPlayer(videoUrl, fileData);
                
            } catch (error) {
                showMessage('Error playing video: ' + error.message, 'error');
            }
        }

        async function setupVideoPlayer(videoUrl, fileData) {
            const videoContainer = document.getElementById('videoContainer');
            const videoInfo = document.getElementById('currentVideoInfo');
            
            // Dispose existing player
            if (player) {
                player.dispose();
            }
            
            // Create video element
            videoContainer.innerHTML = `
                <video id="videoPlayer" class="video-js vjs-default-skin" controls preload="auto" data-setup="{}">
                    <source src="${videoUrl}" type="video/mp4">
                    <p class="vjs-no-js">
                        To view this video please enable JavaScript, and consider upgrading to a 
                        <a href="https://videojs.com/html5-video-support/" target="_blank">web browser that supports HTML5 video</a>.
                    </p>
                </video>
            `;
            
            // Initialize Video.js player
            player = videojs('videoPlayer', {
                fluid: true,
                responsive: true,
                controls: true,
                playbackRates: [0.5, 1, 1.25, 1.5, 2],
                html5: {
                    vhs: {
                        overrideNative: true
                    }
                }
            });
            
            // Show video info
            videoInfo.style.display = 'block';
            videoInfo.innerHTML = `
                <h4>${fileData.name}</h4>
                <p>Size: ${formatFileSize(fileData.size)}</p>
                <p>Source: ${currentSource === 'drive' ? 'Google Drive' : 'Drive Index'}</p>
            `;
        }

        // Download functions
        function downloadFile(button) {
            const fileData = JSON.parse(button.closest('.file-item').dataset.file);
            
            if (fileData.downloadUrl) {
                const link = document.createElement('a');
                link.href = fileData.downloadUrl;
                link.download = fileData.name;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                showMessage('Download URL not available for this file', 'error');
            }
        }

        function downloadSelected() {
            if (selectedFiles.size === 0) {
                showMessage('No files selected', 'error');
                return;
            }
            
            const selectedFileData = currentFiles.filter(file => 
                selectedFiles.has(file.id || file.url) && isVideoFile(file.name)
            );
            
            selectedFileData.forEach(file => {
                if (file.downloadUrl) {
                    const link = document.createElement('a');
                    link.href = file.downloadUrl;
                    link.download = file.name;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
            
            showMessage(`Downloading ${selectedFileData.length} files`, 'success');
        }

        // Selection functions
        function toggleSelection(checkbox) {
            const fileItem = checkbox.closest('.file-item');
            const fileData = JSON.parse(fileItem.dataset.file);
            const fileId = fileData.id || fileData.url;
            
            if (checkbox.checked) {
                selectedFiles.add(fileId);
                fileItem.classList.add('selected');
            } else {
                selectedFiles.delete(fileId);
                fileItem.classList.remove('selected');
            }
            
            updateSelectedCount();
        }

        function selectAll() {
            const videoFiles = currentFiles.filter(file => isVideoFile(file.name));
            videoFiles.forEach(file => {
                selectedFiles.add(file.id || file.url);
            });
            renderFiles();
        }

        function clearSelection() {
            selectedFiles.clear();
            renderFiles();
        }

        function updateSelectedCount() {
            const countElement = document.getElementById('selectedCount');
            const count = selectedFiles.size;
            
            if (count > 0) {
                countElement.textContent = `${count} selected`;
                countElement.style.display = 'inline-block';
            } else {
                countElement.style.display = 'none';
            }
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Only initialize Google API if credentials are provided
            // Hide Google Auth UI since credentials are not configured
            const authBtn = document.getElementById('authBtn');
            const userInfo = document.getElementById('userInfo');
            authBtn.style.display = 'none';
            userInfo.style.display = 'none';
            console.log('Google Drive features disabled - focus on Drive Index functionality');
                        
            // Test the problematic URL
            console.log('Application loaded. You can now test with Drive Index URLs.');
        });
    </script>
</body>
</html>